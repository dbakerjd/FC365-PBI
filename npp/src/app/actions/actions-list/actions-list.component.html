<app-npp-header [currentSection]="'opportunities'"></app-npp-header>
<div class="opportunity-info-wrapper" *ngIf="opportunity">
    <div class="opportunity-name">
        <h2>{{opportunity.Title}}</h2>
        <div>
            <div class="opportunity-active" *ngIf="opportunity.OpportunityStatus == 'Active'"></div>
            <div class="opportunity-archived" *ngIf="opportunity.OpportunityStatus == 'Archive'"></div>
            <span class="opportunity-status">{{opportunity.OpportunityStatus}}</span>
            &nbsp;Â·&nbsp;
            {{opportunity.OpportunityType.Title}}
        </div>
    </div>
    <div class="opportunity-dates">
        <p><label>Project start: </label> {{opportunity.ProjectStartDate | date : 'MMM y'}}</p>
        <p><label>Project end: </label> {{opportunity.ProjectEndDate | date : 'MMM y'}}</p>
    </div>
    <div class="opportunity-molecule">
        <p><label>Molecule Name: </label> {{opportunity.MoleculeName}}</p>
        <p><label>Indication: </label> {{opportunity.Indication.Title}}</p> 
    </div>
    <div class="opportunity-owner">
        <div class="opportunity-owner-pic">
            <div class="opportunity-owner-pic-background"></div>
            <img [src]="profilePic" *ngIf="profilePic"/>
        </div>
        <div class="opportunity-owner-info">
            <div class="opportunity-owner-info-title"><label>Opportunity Owner</label></div>
            <div class="opportunity-owner-info-name" *ngIf="opportunity.EntityOwner">
                {{opportunity.EntityOwner.FirstName + ' ' + opportunity.EntityOwner.LastName}}
            </div>
        </div>
    </div>
</div>
<div class="gates-and-actions-wrapper">
    <div class="gates-wrapper">
        <div class="gates-item-wrapper" *ngFor="let gate of gates">
            <div class="gates-item"  [ngClass]="{'selected-gate': currentGate && currentGate.ID === gate.ID, 'folders-visible': currentSection == 'documents'}" (click)="setGate(gate.ID)">
                <span>{{gate.Title}}</span>
                <svg *ngIf="currentSection == 'documents'">
                    <use xlink:href="assets/symbol-defs.svg#icon-chevron"></use>
                </svg>
            </div>
            <div class="folders-wrapper" *ngIf="currentSection == 'documents' && currentGate && currentGate.ID === gate.ID">
                <div class="folders-item" *ngFor="let folder of gate.folders" [ngClass]="{'selected-folder': currentFolder.ID === folder.ID}" (click)="setFolder(folder.ID)">
                    <svg>
                        <use xlink:href="assets/symbol-defs.svg#icon-folder"></use>
                    </svg>
                    <span>{{folder.Title}}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="actions-wrapper">
        <div class="gate-info-wrapper">
            <div class="gate-info-review">
                <label>{{currentGate?.Title}} Review date: </label>
                {{currentGate?.StageReview | date : 'Y-M-d'}}
            </div>
            <div class="gate-info-progress">
                <label>{{currentGate?.Title}} Progress: </label>
                &nbsp;{{currentGateProgress}}%
                <app-progress-bar [progress]="currentGateProgress"></app-progress-bar>
            </div>
            <div class="gate-info-icons">
                <div class="gate-info-icons-upload" title="Upload file" (click)="openUploadDialog()"></div>
                <div class="gate-info-icons-actions" title="Task List" (click)="setSection('actions')" [ngClass]="{ 'gate-section-selected': currentSection == 'actions' }">
                    <div class="gate-info-icons-selected-section"></div>
                </div>
                <div class="gate-info-icons-documents" title="Supporting Docs" (click)="showFolders()" [ngClass]="{ 'gate-section-selected': currentSection == 'documents' && !currentFolder?.containsModels }">
                    <div class="gate-info-icons-selected-section"></div>
                </div>
                <div class="gate-info-icons-models" title="Forecast Models" (click)="showModels()" [ngClass]="{ 'gate-section-selected': currentSection == 'documents' && currentFolder?.containsModels}">
                    <div class="gate-info-icons-selected-section"></div>
                </div>
                <div class="gate-info-icons-stage-settings" title="Stage Settings" (click)="openStageSettings()" *ngIf="isOwner || isStageUser || currentUser?.IsSiteAdmin"></div>
                <div class="gate-info-icons-department-users" title="Users Access" (click)="openFolderPermissions()" *ngIf="isOwner || isStageUser || currentUser?.IsSiteAdmin"></div>
                
                <div class="gate-info-icons-refresh-bi" title="Refresh Analytics" *ngIf="licensing.license?.HasPowerBi"  (click)="refreshPowerBi()"></div>
                <div class="gate-info-icons-power-bi" title="Go to Power BI" *ngIf="licensing.license?.HasPowerBi"  (click)="navigateTo(opportunity)"></div>
            </div>
        </div>
        <div [ngSwitch]="currentSection">
            <!-- DOCUMENTS LIST -->
            <div *ngSwitchCase="'documents'">
                <div class="documents-files">
                    <app-progress-spinner *ngIf="loading"></app-progress-spinner>
                    <h3 *ngIf="currentFiles.length < 1 && currentFolder && !loading" style="text-align: center;">
                        No files are currently uploaded to <em>{{currentFolder.Title}}</em> folder
                    </h3>
                    <h3 *ngIf="currentFiles.length < 1 && !currentFolder && !loading" style="text-align: center;">
                        There are no stage folders or you don't have access to them 
                    </h3>
                    <div class="documents-files-item" *ngFor="let file of currentFiles">
                        <!-- NORMAL DOCUMENTS -->
                        <ng-container *ngIf="!displayingModels">
                            <div class="documents-files-item-name">
                                <p><label>Name: </label>{{file.Name}}</p>
                            </div>
                            <div class="documents-files-item-uploaded">
                                <p>
                                    <label>Uploaded at </label>{{file.TimeLastModified | date : 'Y-M-d'}} 
                                    <ng-container *ngIf="file.ListItemAllFields.Author"><label> by </label>
                                        {{file.ListItemAllFields.Author.FirstName + ' ' + file.ListItemAllFields.Author.LastName}}
                                    </ng-container>
                                </p>
                            </div>
                            <div class="documents-files-item-comments">
                                <p *ngIf="file.ListItemAllFields.ModelApprovalComments">
                                    <label>Description: </label>
                                    {{file.ListItemAllFields.ModelApprovalComments}}
                                </p>
                            </div>
                            <div class="documents-files-item-icons">
                                <div class="documents-files-item-icons-file" title="Open file" (click)="openFile(file.ListItemAllFields.ID)"></div>
                                <div class="documents-files-item-icons-download" title="Download file" (click)="openFile(file.ListItemAllFields.ID, true)"></div>
                                <div class="documents-files-item-icons-share" title="Share file" (click)="shareFile(file.ListItemAllFields.ID, currentFolder.DepartmentID)"></div>
                                <div class="documents-files-item-icons-edit" title="Edit file name" (click)="editFile(file.ListItemAllFields.ID)"></div>
                                <div class="documents-files-item-icons-remove" title="Delete file" (click)="deleteFile(file.ListItemAllFields.ID)"></div>
                            </div>
                        </ng-container>

                        <!-- FORECASTING MODELS -->
                        <ng-container *ngIf="displayingModels">
                            <div class="documents-files-item-name">
                                <p><label>Name: </label>{{file.Name}}</p>
                                <p *ngIf="file.ListItemAllFields.EntityGeography.EntityGeographyType == 'Geography'">
                                    <label>Geography: </label>
                                    <ng-container>
                                        {{file.ListItemAllFields.EntityGeography.Title}}
                                    </ng-container>
                                </p>
                                <p *ngIf="file.ListItemAllFields.EntityGeography.EntityGeographyType == 'Country'">
                                    <label>Country: </label>
                                    <ng-container>
                                        {{file.ListItemAllFields.EntityGeography.Title}}
                                    </ng-container>
                                </p>
                                <p>
                                    <label>Scenario: </label>
                                    <ng-container *ngFor="let s of file.ListItemAllFields.ModelScenario; let $last = last">
                                        {{s.Title + ($last ? '' : ', ')}}
                                    </ng-container>
                                </p>
                                <p>
                                    <label>Uploaded at </label>{{file.TimeLastModified | date : 'Y-M-d'}}
                                    <ng-container *ngIf="file.ListItemAllFields.Author"><label> by </label>
                                        {{file.ListItemAllFields.Author.FirstName + ' ' + file.ListItemAllFields.Author.LastName}}
                                    </ng-container>
                                </p>
                            </div>
                            <div class="documents-files-item-uploaded">
                                <div>
                                    <p><label>Status: </label>{{file.ListItemAllFields?.ApprovalStatus?.Title}}</p>
                                    <p *ngIf="file.ListItemAllFields?.ApprovalStatus?.Title == 'Submitted'">
                                        <span (click)="approveModel(file, currentFolder.DepartmentID)" class="model-approve-btn" title="Approve the Forecast Model">Approve</span> / 
                                        <span (click)="rejectModel(file, currentFolder.DepartmentID)" class="model-reject-btn" title="Reject the Forecast Model">Reject</span>
                                    </p>
                                </div>
                                <div class="documents-files-item-model-actions">
                                    <div class="model-send-approve-icon" title="Send for Approval" (click)="sendForApproval(file, currentFolder.DepartmentID)"></div>
                                    <div class="model-create-scenario-icon" title="Create Scenario" (click)="createScenario(file)"></div>
                                </div>
                            </div>
                            <div class="documents-files-item-comments">
                                <p *ngIf="file.Description">
                                    <label>Description: </label>{{file.Description}}
                                </p>
                                <p *ngIf="file.ListItemAllFields?.ModelApprovalComments">
                                    <label>Comments: </label>{{file.ListItemAllFields?.ModelApprovalComments}}
                                </p>
                            </div>
                            <div class="documents-files-item-icons">
                                <div class="documents-files-item-icons-file" title="Open file" (click)="openFile(file.ListItemAllFields.ID)"></div>
                                <div class="documents-files-item-icons-download" title="Download file" (click)="openFile(file.ListItemAllFields.ID, true)"></div>
                                <div class="documents-files-item-icons-share" title="Share file" (click)="shareFile(file.ListItemAllFields.ID, currentFolder.DepartmentID)"></div>
                                <div class="documents-files-item-icons-edit" title="Edit file name" (click)="editFile(file.ListItemAllFields.ID)"></div>
                                <div class="documents-files-item-icons-remove" title="Delete file" (click)="deleteFile(file.ListItemAllFields.ID)"></div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
            <!-- ACTIONS LIST -->
            <div *ngSwitchDefault>
                <div class="action-item" *ngFor="let action of currentActions">
                    <div class="action-item-name"><span>{{action.Title}}</span></div>
                    <div class="action-item-completed" *ngIf="action.Complete">
                        <label>Completed: </label>
                        {{action.Timestamp | date : 'Y-M-d'}}
                        <label> at </label>
                        {{action.Timestamp | date : 'HH:mm'}}
                        <label> by </label>
                        <ng-container *ngIf="action.TargetUser">{{action.TargetUser.FirstName + ' ' + action.TargetUser.LastName}}</ng-container>
                    </div>
                    <div class="action-item-completed" *ngIf="!action.Complete"><label>Not completed yet</label></div>
                    <div class="action-item-due" *ngIf="action.ActionDueDate">
                        <label>Due by </label>
                        <ngx-datepicker [(ngModel)]="action.ActionDueDate" (ngModelChange)="onDueDateChange(action.ID, $event)" [options]="dateOptions" *ngIf="isOwner || currentUser?.IsSiteAdmin"></ngx-datepicker>
                        <span *ngIf="!isOwner && !currentUser?.IsSiteAdmin">{{action.ActionDueDate | date: 'Y-M-d'}}</span>
                    </div>
                    <div class="action-item-status">
                        <div class="action-item-status-button" (click)="toggleStatus(action)" [ngClass]="{ 'action-completed': action.status == 'completed', 'action-late': action.status == 'late', 'action-pending': action.status == 'pending'}">
                            <span>{{action.status}}</span>
                            <div class="action-item-status-icon"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions-list-button" *ngIf="currentSection == 'actions' && currentGateProgress == 100 && currentGate?.ID == lastStageId && (isOwner || currentUser?.IsSiteAdmin)">
                <div class="action-item-next-button" (click)="goNextStage()" *ngIf="nextStage">
                    Go to Next Stage
                    <div class="action-item-next-button-icon"></div>
                </div>
                <div class="action-item-next-button" (click)="completeOpportunity()" *ngIf="!nextStage && opportunity.OpportunityStatus == 'Active'">
                    Complete Opportunity
                    <div class="action-item-next-button-icon"></div>
                </div>
            </div>
        </div>
        
    </div>
</div>
